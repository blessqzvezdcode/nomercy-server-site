<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–∞—Ä–∫–µ—Ç - NoMercy</title>
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/market.css">
</head>
<body>
    <nav>
        <a href="/" class="brand">NoMercy</a>
        <div class="nav-buttons">
            <% if (user) { %>
                <a href="/messenger" class="nav-messenger-btn" title="–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä">üí¨</a>
                <div class="dropdown">
                    <button class="dropdown-toggle">
                        <span>üë§ <%= user.name %> (üí∞ <%= balance %>)</span>
                    </button>
                    <div class="dropdown-menu">
                        <a href="/" class="dropdown-item">üè† –ì–ª–∞–≤–Ω–∞—è</a>
                        <a href="/profile/<%= user.id %>" class="dropdown-item">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
                        <a href="/market" class="dropdown-item active">üõí –ú–∞—Ä–∫–µ—Ç</a>
                        <a href="/cards" class="dropdown-item">üÉè –ö–∞—Ä—Ç—ã</a>
                        <a href="/quests" class="dropdown-item">‚öîÔ∏è –ö–≤–µ—Å—Ç—ã</a>
                        <a href="/games" class="dropdown-item">üéÆ –ò–≥—Ä—ã</a>
                        <a href="/news" class="dropdown-item">üì∞ –ù–æ–≤–æ—Å—Ç–∏</a>
                        <a href="/faq" class="dropdown-item">‚ùì FAQ</a>
                        <a href="/achievements" class="dropdown-item">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</a>
                        <a href="/support" class="dropdown-item">üéß –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
                        <div class="dropdown-divider"></div>
                        <% if (user.role === 'admin') { %>
                            <a href="/admin" class="dropdown-item">‚öôÔ∏è –ê–¥–º–∏–Ω–∫–∞</a>
                            <div class="dropdown-divider"></div>
                        <% } %>
                        <button class="dropdown-item theme-toggle" id="theme-toggle">üåô –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</button>
                        <div class="dropdown-divider"></div>
                        <a href="/logout" class="dropdown-item">üö™ –í—ã–π—Ç–∏</a>
                    </div>
                </div>
            <% } else { %>
                <a href="/auth/discord" class="btn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord</a>
            <% } %>
        </div>
    </nav>

<div class="container">
  <div class="market-header">
    <div class="market-info">
      <h1 class="market-title">üõí –ú–∞—Ä–∫–µ—Ç-—Ü–µ–Ω—Ç—Ä</h1>
      <p class="market-subtitle">–ü–æ–∫—É–ø–∞–π –∏ –ø—Ä–æ–¥–∞–≤–∞–π –∫–∞—Ä—Ç—ã —Å –¥—Ä—É–≥–∏–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏</p>
    </div>
    <div class="balance-card">
      <div class="balance-header">
        <span class="balance-icon">üí∞</span>
        <span class="balance-label">–¢–≤–æ–π –±–∞–ª–∞–Ω—Å</span>
      </div>
      <div class="balance-amount" id="balance"><%= balance %></div>
      <% if (user) { %><div class="balance-user">–ü—Ä–∏–≤–µ—Ç, <%= user.name %></div><% } %>
    </div>
  </div>

  <!-- –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ—Ç–∞ -->
  <div class="card create-listing-card" style="margin-bottom:24px;">
    <div class="create-header">
      <div class="create-icon">‚ú®</div>
      <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ª–æ—Ç</h3>
      <p class="small">–†–∞–∑–º–µ—Å—Ç–∏—Ç–µ —Å–≤–æ–π —Ç–æ–≤–∞—Ä –Ω–∞ –º–∞—Ä–∫–µ—Ç–µ –∏ –Ω–∞—á–Ω–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤–∞—Ç—å</p>
    </div>
    <form action="/market/list" method="POST" enctype="multipart/form-data" class="create-form">
      <div class="form-section">
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
          <input name="title" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –¢–æ–≤–∞—Ä)">
        </div>
        <div class="form-group">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea name="description" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à —Ç–æ–≤–∞—Ä –ø–æ–¥—Ä–æ–±–Ω–æ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞)" rows="3"></textarea>
        </div>
        <div class="form-group">
          <label>–¶–µ–Ω–∞ (NMCoin)</label>
          <input name="price" type="number" placeholder="100 (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)" min="1">
        </div>
      </div>
      <div class="form-section">
        <div class="form-group">
          <label>–¢–∏–ø –ø—Ä–æ–¥–∞–∂–∏</label>
          <select name="type">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ü—Ä—è–º–∞—è –ø—Ä–æ–¥–∞–∂–∞)</option>
            <option value="direct">–ü—Ä—è–º–∞—è –ø—Ä–æ–¥–∞–∂–∞</option>
            <option value="auction">–ê—É–∫—Ü–∏–æ–Ω</option>
            <option value="permanent">–ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –ø—Ä–æ–¥–∞–∂–∞</option>
          </select>
        </div>
        <div class="form-group" id="duration-group">
          <label>–í—Ä–µ–º—è –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è (—á–∞—Å—ã)</label>
          <input name="durationHours" type="number" placeholder="24" value="24" min="1" max="168">
        </div>
        <div class="form-group">
          <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
          <input name="images" type="file" multiple accept="image/*">
        </div>
        <button class="btn create-btn" type="submit">
          <span>üöÄ</span>
          –°–æ–∑–¥–∞—Ç—å –ª–æ—Ç
        </button>
      </div>
    </form>
  </div>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="card filters-card">
    <div class="filters-row">
      <div class="filter-group">
        <label>üîç –ü–æ–∏—Å–∫</label>
        <input type="text" id="search" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ...">
      </div>
      <div class="filter-group">
        <label>üìã –¢–∏–ø</label>
        <select id="typeFilter">
          <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
          <option value="direct">–ü—Ä—è–º–∞—è –ø—Ä–æ–¥–∞–∂–∞</option>
          <option value="auction">–ê—É–∫—Ü–∏–æ–Ω</option>
        </select>
      </div>
      <div class="filter-group">
        <label>üìä –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
        <select id="sortFilter">
          <option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
          <option value="price_asc">–¶–µ–Ω–∞ ‚Üë</option>
          <option value="price_desc">–¶–µ–Ω–∞ ‚Üì</option>
        </select>
      </div>
      <button class="btn" onclick="applyFilters()">
        <span>‚ö°</span>
        –ü—Ä–∏–º–µ–Ω–∏—Ç—å
      </button>
    </div>
  </div>

  <!-- –°–ø–∏—Å–æ–∫ –ª–æ—Ç–æ–≤ -->
  <div class="card">
    <div class="listings-header">
      <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h3>
      <div class="listing-status">
        <span class="status-badge direct">–ü—Ä—è–º—ã–µ –ø—Ä–æ–¥–∞–∂–∏</span>
        <span class="status-badge auction">–ê—É–∫—Ü–∏–æ–Ω—ã</span>
      </div>
    </div>
    <div id="listings-container">
      <% if (listings && listings.length) { %>
        <% listings.forEach(function(listing){ %>
          <div class="listing">
            <div class="listing-content">
              <div class="listing-image">
                <% if (listing.images && listing.images.length > 0) { %>
                  <img src="<%= listing.images[0] %>" alt="<%= listing.title %>">
                <% } else { %>
                  <div class="no-image">
                    <span>üì∑</span>
                    <span>–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                  </div>
                <% } %>
              </div>
              <div class="listing-info">
                <div class="listing-title">
                  <%= listing.title %>
                  <% if (listing.pinned) { %>
                    <span class="status-badge pinned">üìå –ó–∞–∫—Ä–µ–ø–ª–µ–Ω</span>
                  <% } %>
                  <% if (listing.permanent) { %>
                    <span class="status-badge permanent">‚ôæÔ∏è –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π</span>
                    <% if (listing.totalSales && listing.totalSales > 0) { %>
                      <span class="status-badge sales">üõí –ü—Ä–æ–¥–∞–Ω–æ: <%= listing.totalSales %></span>
                    <% } %>
                  <% } %>
                </div>
                <div class="listing-description"><%= listing.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è' %></div>
                <div class="listing-meta">
                  <span class="status-badge <%= listing.type %>">
                    <% if (listing.type === 'auction') { %>
                      üèÜ –ê—É–∫—Ü–∏–æ–Ω
                    <% } else { %>
                      üí∞ –ü—Ä—è–º–∞—è –ø—Ä–æ–¥–∞–∂–∞
                    <% } %>
                  </span>
                  <% if (listing.type === 'auction' && listing.endsAt) { %>
                    <span class="time-left">‚è∞ <%= new Date(listing.endsAt).toLocaleString() %></span>
                  <% } %>
                  <div class="listing-seller">
                    <span class="seller-info">
                      üë§ –ü—Ä–æ–¥–∞–≤–µ—Ü: 
                      <a href="/profile/<%= listing.owner %>" class="seller-link" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">
                        <%= listing.ownerName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π' %>
                      </a>
                      <span class="seller-status <%= listing.ownerStatus === '–û–Ω–ª–∞–π–Ω' ? 'online' : 'offline' %>">
                        ‚Ä¢ <%= listing.ownerStatus || '–û—Ñ–ª–∞–π–Ω' %>
                      </span>
                    </span>
                    <% if (user && user.id !== listing.owner) { %>
                      <a href="/messenger?chat=<%= listing.owner %>" class="btn btn-small btn-secondary discuss-btn" title="–ù–∞–ø–∏—Å–∞—Ç—å –ø—Ä–æ–¥–∞–≤—Ü—É">
                        üí¨ –û–±—Å—É–∂–¥–µ–Ω–∏–µ
                      </a>
                    <% } %>
                  </div>
                </div>
              </div>
            </div>
            <div class="listing-actions">
              <div class="listing-price">
                <span class="price-amount"><%= listing.price %></span>
                <span class="price-currency">NMCoin</span>
              </div>
              <% if (user && user.id !== listing.owner) { %>
                <% if (listing.type === 'auction') { %>
                  <form method="POST" action="/market/bid/<%= listing.id %>" class="bid-form">
                    <input name="amount" type="number" placeholder="–°—Ç–∞–≤–∫–∞" min="<%= listing.highestBid ? listing.highestBid.amount + 1 : listing.price %>" class="bid-input">
                    <button class="btn bid-btn" type="submit">
                      <span>üéØ</span>
                      –°—Ç–∞–≤–∫–∞
                    </button>
                  </form>
                <% } else { %>
                  <form method="POST" action="/market/buy/<%= listing.id %>">
                    <button class="btn buy-btn" type="submit">
                      <span>üõí</span>
                      –ö—É–ø–∏—Ç—å
                    </button>
                  </form>
                <% } %>
              <% } else { %>
                <div class="own-listing">–≠—Ç–æ –≤–∞—à–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</div>
              <% } %>
            </div>
            
            <!-- Messages Section -->
            <div class="listing-messages" id="messages-<%= listing.id %>" style="display: none;">
              <div class="messages-header">
                <h4>üí¨ –û–±—Å—É–∂–¥–µ–Ω–∏–µ –ª–æ—Ç–∞</h4>
                <button class="toggle-messages" onclick="toggleMessages('<%= listing.id %>')">–°–≤–µ—Ä–Ω—É—Ç—å</button>
              </div>
              <div class="messages-list" id="messages-list-<%= listing.id %>">
                <!-- Messages will be loaded here -->
              </div>
              <% if (user) { %>
                <div class="message-form">
                  <form method="POST" action="/market/message/<%= listing.id %>" class="send-message-form">
                    <input name="message" type="text" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." required>
                    <button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                  </form>
                </div>
              <% } %>
            </div>
            
            <!-- Toggle Messages Button -->
            <div class="listing-footer">
              <button class="btn ghost toggle-messages-btn" onclick="toggleMessages('<%= listing.id %>')">
                <span>üí¨</span>
                –û–±—Å—É–∂–¥–µ–Ω–∏–µ
              </button>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="empty-state">
          <div class="empty-icon">üì¶</div>
          <h4>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π</h4>
          <p>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –∏ –Ω–∞—á–Ω–∏—Ç–µ —Ç–æ—Ä–≥–æ–≤–∞—Ç—å!</p>
        </div>
      <% } %>
    </div>
  </div>

  <a href="/" class="btn ghost" style="margin-top:20px;">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
</div>

<script>
function applyFilters() {
  const search = document.getElementById('search').value;
  const type = document.getElementById('typeFilter').value;
  const sort = document.getElementById('sortFilter').value;
  
  const params = new URLSearchParams();
  if (search) params.append('search', search);
  if (type) params.append('type', type);
  if (sort) params.append('sort', sort);
  
  window.location.href = '/market?' + params.toString();
}
</script>

<script>
// –°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –ø—Ä–æ–¥–∞–∂–∏
document.addEventListener('DOMContentLoaded', function() {
    const typeSelect = document.querySelector('select[name="type"]');
    const durationGroup = document.getElementById('duration-group');
    
    if (typeSelect && durationGroup) {
        typeSelect.addEventListener('change', function() {
            if (this.value === 'permanent') {
                durationGroup.style.display = 'none';
            } else {
                durationGroup.style.display = 'block';
            }
        });
    }
});
</script>

<script src="/js/ui-effects.js"></script>
<script src="/js/dropdown.js"></script>
<script src="/js/theme-switcher.js"></script>
</body>
</html>