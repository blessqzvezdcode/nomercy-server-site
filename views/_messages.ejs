<!-- Messages Widget -->
<div class="messages-widget" id="messagesWidget">
  <div class="messages-header" onclick="toggleMessages()">
    <div class="messages-title">
      <span class="messages-icon">üí¨</span>
      <span>–°–æ–æ–±—â–µ–Ω–∏—è</span>
      <span class="messages-count" id="messagesCount">0</span>
    </div>
    <div class="messages-toggle" id="messagesToggle">‚ñº</div>
  </div>
  
  <div class="messages-content" id="messagesContent" style="display: none;">
    <div class="messages-list" id="messagesList">
      <div class="empty-messages">
        <span class="empty-icon">üì≠</span>
        <p>–ù–µ—Ç –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π</p>
      </div>
    </div>
    
    <div class="messages-compose">
      <div class="compose-header">
        <span>–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</span>
      </div>
      <form id="messageForm" class="message-form">
        <div class="form-group">
          <input type="text" id="messageRecipient" placeholder="ID –ø–æ–ª—É—á–∞—Ç–µ–ª—è" required>
        </div>
        <div class="form-group">
          <textarea id="messageText" placeholder="–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è" required rows="3"></textarea>
        </div>
        <button type="submit" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </form>
    </div>
  </div>
</div>

<script>
let messages = JSON.parse(localStorage.getItem('messages') || '[]');
let isMessagesOpen = false;

function toggleMessages() {
  const content = document.getElementById('messagesContent');
  const toggle = document.getElementById('messagesToggle');
  
  isMessagesOpen = !isMessagesOpen;
  
  if (isMessagesOpen) {
    content.style.display = 'block';
    toggle.textContent = '‚ñ≤';
  } else {
    content.style.display = 'none';
    toggle.textContent = '‚ñº';
  }
}

function updateMessagesCount() {
  const unreadCount = messages.filter(m => !m.read).length;
  document.getElementById('messagesCount').textContent = unreadCount;
}

function loadMessages() {
  const messagesList = document.getElementById('messagesList');
  
  if (messages.length === 0) {
    messagesList.innerHTML = `
      <div class="empty-messages">
        <span class="empty-icon">üì≠</span>
        <p>–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
      </div>
    `;
    return;
  }
  
  messagesList.innerHTML = messages.map(message => `
    <div class="message-item ${message.read ? '' : 'unread'}" onclick="markAsRead('${message.id}')">
      <div class="message-header">
        <span class="message-from">–û—Ç: ${message.from}</span>
        <span class="message-time">${new Date(message.timestamp).toLocaleString('ru-RU')}</span>
      </div>
      <div class="message-text">${message.text}</div>
    </div>
  `).join('');
}

function markAsRead(messageId) {
  const message = messages.find(m => m.id === messageId);
  if (message) {
    message.read = true;
    localStorage.setItem('messages', JSON.stringify(messages));
    loadMessages();
    updateMessagesCount();
  }
}

function sendMessage() {
  const recipient = document.getElementById('messageRecipient').value;
  const text = document.getElementById('messageText').value;
  
  if (!recipient || !text) {
    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    return;
  }
  
  const message = {
    id: Date.now().toString(),
    from: '<%= user ? user.name : "–ê–Ω–æ–Ω–∏–º" %>',
    to: recipient,
    text: text,
    timestamp: new Date().toISOString(),
    read: false
  };
  
  messages.unshift(message);
  localStorage.setItem('messages', JSON.stringify(messages));
  
  document.getElementById('messageForm').reset();
  loadMessages();
  updateMessagesCount();
  
  alert('–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
}

// Event listeners
document.getElementById('messageForm').addEventListener('submit', function(e) {
  e.preventDefault();
  sendMessage();
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  loadMessages();
  updateMessagesCount();
});
</script>


