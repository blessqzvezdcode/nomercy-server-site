<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–∞–≥–∞–∑–∏–Ω - NoMercy</title>
<link rel="stylesheet" href="/css/base.css">
</head>
<body>
    <nav>
  <a href="/" class="brand">NoMercy</a>
  <div class="nav-buttons">
  <% if (user) { %>
    <div class="dropdown">
      <button class="dropdown-toggle">
        <span>–ú–µ–Ω—é</span>
      </button>
      <div class="dropdown-menu">
        <a href="/profile/<%= user.id %>" class="dropdown-item">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="/market" class="dropdown-item">üõí –ú–∞—Ä–∫–µ—Ç</a>
        <a href="/cards" class="dropdown-item">üÉè –ö–æ–ª–ª–µ–∫—Ü–∏—è</a>
        <a href="/news" class="dropdown-item">üì∞ –ù–æ–≤–æ—Å—Ç–∏</a>
        <a href="/quests" class="dropdown-item">üìã –ö–≤–µ—Å—Ç—ã</a>
        <a href="/games" class="dropdown-item">üé∞ –ú–∏–Ω–∏-–ò–≥—Ä—ã</a>
        <a href="/achievements" class="dropdown-item">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</a>
        <a href="/faq" class="dropdown-item">‚ùì FAQ</a>
        <div class="dropdown-divider"></div>
        <a href="/logout" class="dropdown-item">üö™ –í—ã–π—Ç–∏</a>
      </div>
    </div>
  <% } else { %>
    <a href="/auth/discord" class="btn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord</a>
  <% } %>
  </div>
</nav>


<div class="container">
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;"><a href="/market" class="btn">–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å</a><div class="small">–°–æ–∑–¥–∞–≤–∞—Ç—å –ª–æ—Ç—ã –º–æ–∂–Ω–æ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –≤ —ç—Ç–æ–º –º–∞–≥–∞–∑–∏–Ω–µ.</div></div>
  <h2>–ú–∞–≥–∞–∑–∏–Ω –≤–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤</h2>
  <div id="shop-list" class="grid"></div>
  <h3>–°–æ–∑–¥–∞—Ç—å –ª–æ—Ç –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</h3>
  <div id="sell-list" class="grid"></div>
  <a href="/" class="btn ghost">–ù–∞–∑–∞–¥</a>
</div>

<script>
async function loadShop() {
  const res = await fetch('/shopitems.json');
  const items = await res.json();
  const container = document.getElementById('shop-list');
  container.innerHTML = '';
  items.forEach((it, idx) => {
    const el = document.createElement('div');
    el.className = 'shop-item card';
    el.innerHTML = `<h4>${it.name}</h4><p>–¶–µ–Ω–∞: ${it.price} –º–æ–Ω–µ—Ç</p><div class="form-inline"><button class="btn" onclick="buy(${idx}, this)">–ö—É–ø–∏—Ç—å</button></div>`;
    container.appendChild(el);
  });
  loadSellableInventory();
}

async function loadSellableInventory(){
  const res = await fetch('/api/inventory');
  const data = await res.json();
  const sell = document.getElementById('sell-list');
  sell.innerHTML = '';
  data.inventory.forEach((it, idx)=>{
    // allow selling non-card items
    if (it.type !== 'card') {
      const el = document.createElement('div');
      el.className = 'shop-item card';
      el.innerHTML = `<strong>${it.name}</strong><div class="small">–¢–∏–ø: ${it.type}</div><div class="form-inline"><input id="price_${idx}" placeholder="–¶–µ–Ω–∞" /><button class="btn ghost" onclick="createLot(${idx})">–°–æ–∑–¥–∞—Ç—å –ª–æ—Ç</button></div>`;
      sell.appendChild(el);
    }
  });
}

async function createLot(idx){
  const price = parseInt(document.getElementById('price_'+idx).value || '0');
  if (!price || price <= 0){ alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É'); return; }
  const resp = await fetch('/api/market/list', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({inventoryIndex: idx, price})});
  const data = await resp.json();
  if (data.ok){ alert('–õ–æ—Ç —Å–æ–∑–¥–∞–Ω'); loadSellableInventory(); } else alert(data.error || '–û—à–∏–±–∫–∞');
}

async function buy(idx, btn) {
  btn.disabled = true;
  const res = await fetch('/api/buy', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({index: idx})});
  const data = await res.json();
  if (data.ok) {
    alert('–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞! –ë–∞–ª–∞–Ω—Å: ' + data.balance);
    document.getElementById('balance')?.textContent = data.balance;
    loadSellableInventory();
  } else {
    alert(data.error || '–û—à–∏–±–∫–∞');
  }
  btn.disabled = false;
}
window.addEventListener('DOMContentLoaded', loadShop);
</script>
<script src="/js/dropdown.js"></script>
</body>
</html>