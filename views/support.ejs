<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ - NoMercy</title>
    <link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/support.css">
</head>
<body>
    <nav>
        <a href="/" class="brand">NoMercy</a>
        <div class="nav-buttons">
            <button id="backBtn" class="btn">‚Üê –ù–∞–∑–∞–¥</button>
            <button id="theme-toggle" class="btn ghost">üåô –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞</button>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>üéß –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h1>
            <p>–ú—ã –≥–æ—Ç–æ–≤—ã –ø–æ–º–æ—á—å –≤–∞–º —Ä–µ—à–∏—Ç—å –ª—é–±—ã–µ –≤–æ–ø—Ä–æ—Å—ã</p>
        </div>

        <% if (user) { %>
            <div class="support-form-container">
                <h2>üìù –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</h2>
                <form id="supportForm" class="support-form">
                    <div class="form-group">
                        <label for="subject">–¢–µ–º–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è:</label>
                        <select id="subject" name="subject" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É</option>
                            <option value="technical">üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞</option>
                            <option value="payment">üí∞ –í–æ–ø—Ä–æ—Å –ø–æ –ø–ª–∞—Ç–µ–∂–∞–º</option>
                            <option value="trading">üõí –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–æ—Ä–≥–æ–≤–ª–µ–π</option>
                            <option value="account">üë§ –í–æ–ø—Ä–æ—Å –ø–æ –∞–∫–∫–∞—É–Ω—Ç—É</option>
                            <option value="ban">‚ö†Ô∏è –û–±–∂–∞–ª–æ–≤–∞–Ω–∏–µ –±–∞–Ω–∞</option>
                            <option value="bug">üêõ –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ</option>
                            <option value="suggestion">üí° –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</option>
                            <option value="other">‚ùì –î—Ä—É–≥–æ–µ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="message">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:</label>
                        <textarea id="message" name="message" rows="6" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –ø—Ä–æ–±–ª–µ–º—É –ø–æ–¥—Ä–æ–±–Ω–æ..." required></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>
                </form>
            </div>

            <div class="support-tickets" id="supportTickets">
                <h2>üìã –ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h2>
                <div id="ticketsList">
                    <p class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—Ä–∞—â–µ–Ω–∏–π...</p>
                </div>
            </div>
        <% } else { %>
            <div class="auth-required">
                <h2>üîê –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
                <p>–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.</p>
                <a href="/auth/discord" class="btn btn-primary">üí¨ –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Discord</a>
            </div>
        <% } %>

        <div class="support-info">
            <h2>‚ÑπÔ∏è –ü–æ–ª–µ–∑–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
            <div class="info-grid">
                <div class="info-card">
                    <h3>‚è±Ô∏è –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</h3>
                    <p>–û–±—ã—á–Ω–æ –º—ã –æ—Ç–≤–µ—á–∞–µ–º –≤ —Ç–µ—á–µ–Ω–∏–µ 24 —á–∞—Å–æ–≤. –°—Ä–æ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Ä–∞—Å—Å–º–∞—Ç—Ä–∏–≤–∞—é—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ.</p>
                </div>
                
                <div class="info-card">
                    <h3>üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h3>
                    <p>–ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –æ–±—Ä–∞—â–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ <a href="/faq">—Ä–∞–∑–¥–µ–ª FAQ</a> - –≤–æ–∑–º–æ–∂–Ω–æ, –æ—Ç–≤–µ—Ç —É–∂–µ –µ—Å—Ç—å —Ç–∞–º.</p>
                </div>
                
                <div class="info-card">
                    <h3>üîç –î–µ—Ç–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã</h3>
                    <p>–ß–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ –≤—ã –æ–ø–∏—à–µ—Ç–µ –ø—Ä–æ–±–ª–µ–º—É, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –º—ã —Å–º–æ–∂–µ–º –≤–∞–º –ø–æ–º–æ—á—å.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/theme-switcher.js"></script>
    <script>
        document.getElementById('backBtn').addEventListener('click', () => {
            history.back();
        });
    </script>
    <% if (user) { %>
    <script>
        document.getElementById('supportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                subject: formData.get('subject'),
                message: formData.get('message')
            };
            
            try {
                const response = await fetch('/api/support/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ –û–±—Ä–∞—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ! –ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.');
                    e.target.reset();
                    loadTickets();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è: ' + result.error);
                }
            } catch (error) {
                alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ–±—Ä–∞—â–µ–Ω–∏—è');
                console.error('Error:', error);
            }
        });
        
        async function loadTickets() {
            try {
                const response = await fetch('/api/support/tickets');
                const result = await response.json();
                
                const ticketsList = document.getElementById('ticketsList');
                
                if (result.success && result.tickets.length > 0) {
                    ticketsList.innerHTML = result.tickets.map(ticket => `
                        <div class="ticket-item ${ticket.status}">
                            <div class="ticket-header">
                                <span class="ticket-id">#${ticket.id}</span>
                                <span class="ticket-subject">${getSubjectIcon(ticket.subject)} ${getSubjectName(ticket.subject)}</span>
                                <span class="ticket-status status-${ticket.status}">${getStatusName(ticket.status)}</span>
                            </div>
                            <div class="ticket-message">${ticket.message.substring(0, 100)}${ticket.message.length > 100 ? '...' : ''}</div>
                            <div class="ticket-date">–°–æ–∑–¥–∞–Ω–æ: ${new Date(ticket.createdAt).toLocaleString('ru-RU')}</div>
                            ${ticket.response ? `<div class="ticket-response"><strong>–û—Ç–≤–µ—Ç:</strong> ${ticket.response}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    ticketsList.innerHTML = '<p class="no-tickets">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π</p>';
                }
            } catch (error) {
                document.getElementById('ticketsList').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–±—Ä–∞—â–µ–Ω–∏–π</p>';
                console.error('Error loading tickets:', error);
            }
        }
        
        function getSubjectIcon(subject) {
            const icons = {
                'technical': 'üîß',
                'payment': 'üí∞',
                'trading': 'üõí',
                'account': 'üë§',
                'ban': '‚ö†Ô∏è',
                'bug': 'üêõ',
                'suggestion': 'üí°',
                'other': '‚ùì'
            };
            return icons[subject] || '‚ùì';
        }
        
        function getSubjectName(subject) {
            const names = {
                'technical': '–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞',
                'payment': '–í–æ–ø—Ä–æ—Å –ø–æ –ø–ª–∞—Ç–µ–∂–∞–º',
                'trading': '–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–æ—Ä–≥–æ–≤–ª–µ–π',
                'account': '–í–æ–ø—Ä–æ—Å –ø–æ –∞–∫–∫–∞—É–Ω—Ç—É',
                'ban': '–û–±–∂–∞–ª–æ–≤–∞–Ω–∏–µ –±–∞–Ω–∞',
                'bug': '–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ',
                'suggestion': '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',
                'other': '–î—Ä—É–≥–æ–µ'
            };
            return names[subject] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }
        
        function getStatusName(status) {
            const names = {
                'open': '–û—Ç–∫—Ä—ã—Ç–æ',
                'in_progress': '–í —Ä–∞–±–æ—Ç–µ',
                'closed': '–ó–∞–∫—Ä—ã—Ç–æ'
            };
            return names[status] || status;
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        loadTickets();
    </script>
    <% } %>
</body>
</html>
